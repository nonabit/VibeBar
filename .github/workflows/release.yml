name: Release macOS App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "发布 Tag（例如 v1.0.1）；留空表示使用当前 ref"
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 解析发布标签
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" && -n "${GITHUB_REF_NAME:-}" ]]; then
            TAG="$GITHUB_REF_NAME"
          elif [[ -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
            git fetch --force origin "refs/tags/$TAG:refs/tags/$TAG"
            git checkout "tags/$TAG"
          else
            echo "错误：workflow_dispatch 触发时请传入 tag（如 v1.0.1）" >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: 选择 Swift 6.2+ 的 Xcode
        shell: bash
        run: |
          set -euo pipefail

          XCODE_APPS="$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -r || true)"
          if [[ -z "$XCODE_APPS" ]]; then
            echo "错误：Runner 上没有发现可用的 Xcode 安装。" >&2
            exit 1
          fi

          FOUND=""
          while IFS= read -r APP; do
            [[ -z "$APP" ]] && continue
            DEV_DIR="$APP/Contents/Developer"
            sudo xcode-select -s "$DEV_DIR"
            SWIFT_LINE="$(xcrun swift --version | head -n 1)"
            echo "检查 $APP -> $SWIFT_LINE"

            if echo "$SWIFT_LINE" | grep -Eq 'Swift version (6\.[2-9]|[7-9]\.)'; then
              FOUND="$APP"
              break
            fi
          done <<< "$XCODE_APPS"

          if [[ -z "$FOUND" ]]; then
            echo "错误：未找到 Swift 6.2+ 的 Xcode。当前依赖 SweetCookieKit@0.4.0 需要 Swift 6.2+。" >&2
            exit 1
          fi

          echo "已选择 Xcode: $FOUND"
          xcodebuild -version
          xcrun swift --version

      - name: 构建 macOS Archive
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project VibeBar.xcodeproj \
            -scheme VibeBar \
            -configuration Release \
            -destination "platform=macOS" \
            -archivePath "$RUNNER_TEMP/VibeBar.xcarchive" \
            archive

      - name: 打包发布产物
        id: package
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist
          RAW_TAG="${{ steps.meta.outputs.tag }}"
          VERSION="${RAW_TAG#v}"
          ZIP_NAME="VibeBar-${VERSION}-macOS-universal.zip"
          SHA_NAME="VibeBar-${VERSION}-macOS-universal.sha256"

          ditto -c -k --sequesterRsrc --keepParent \
            "$RUNNER_TEMP/VibeBar.xcarchive/Products/Applications/VibeBar.app" \
            "dist/$ZIP_NAME"

          shasum -a 256 "dist/$ZIP_NAME" > "dist/$SHA_NAME"

          echo "zip=dist/$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "sha=dist/$SHA_NAME" >> "$GITHUB_OUTPUT"

      - name: 创建或更新 GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ steps.meta.outputs.tag }}"
          TITLE="VibeBar $TAG"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" \
              "${{ steps.package.outputs.zip }}" \
              "${{ steps.package.outputs.sha }}" \
              --clobber
          else
            gh release create "$TAG" \
              "${{ steps.package.outputs.zip }}" \
              "${{ steps.package.outputs.sha }}" \
              --title "$TITLE" \
              --notes "自动构建发布包。"
          fi
